name: ðŸš€ Deploy Archive API to AWS Elastic Beanstalk

on:
  push:
    branches: [ main ]
    paths:
      - 'archive-api/**'
      - 'archive-auth/**'
      - 'archive-common/**'
      - 'archive-domain/**'
      - 'archive-chatbot/**'
      - 'build.gradle.kts'
      - 'settings.gradle.kts'
      - 'Dockerfile'
      - '.ebextensions/**'
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: archive-api
  EB_APPLICATION_NAME: archive-server-eb
  EB_ENVIRONMENT_NAME: archive-prod

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: â˜• Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: ðŸ“¦ Cache Gradle dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: ðŸ”¨ Build with Gradle
      run: |
        chmod +x ./gradlew
        ./gradlew clean build -x test
        
    - name: ðŸ” Get version info
      id: version
      run: |
        VERSION=$(grep -E '^version\s*=' build.gradle.kts | sed -E 's/.*"(.+)".*/\1/')
        COMMIT_HASH=$(echo ${{ github.sha }} | cut -c1-7)
        IMAGE_TAG="${VERSION}-${COMMIT_HASH}"
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_OUTPUT
        echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_OUTPUT
        echo "ðŸ“¦ Building version: $IMAGE_TAG"
        
    - name: ðŸ” Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
      
    - name: ðŸ”‘ Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
      
    - name: ðŸ³ Build and Push Docker Image to ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ steps.version.outputs.IMAGE_TAG }}
      run: |
        echo "ðŸ—ï¸ Building Docker image..."
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
        
        echo "â¬†ï¸ Pushing to ECR..."
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
        
        echo "âœ… Image pushed: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
        
    - name: ðŸ“ Create Dockerrun.aws.json
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ steps.version.outputs.IMAGE_TAG }}
      run: |
        cat > Dockerrun.aws.json << EOF
        {
          "AWSEBDockerrunVersion": "1",
          "Image": {
            "Name": "$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG",
            "Update": "true"
          },
          "Ports": [
            {
              "ContainerPort": 5000,
              "HostPort": 5000
            }
          ]
        }
        EOF
        echo "âœ… Dockerrun.aws.json created"
        cat Dockerrun.aws.json
        
    - name: ðŸ“¦ Create deployment package
      run: |
        zip -r deploy-${{ steps.version.outputs.COMMIT_HASH }}.zip Dockerrun.aws.json .ebextensions
        echo "âœ… Deployment package created"
        
    - name: ðŸš€ Deploy to Elastic Beanstalk
      uses: einaregilsson/beanstalk-deploy@v22
      with:
        aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        application_name: ${{ env.EB_APPLICATION_NAME }}
        environment_name: ${{ env.EB_ENVIRONMENT_NAME }}
        version_label: ${{ steps.version.outputs.IMAGE_TAG }}
        region: ${{ env.AWS_REGION }}
        deployment_package: deploy-${{ steps.version.outputs.COMMIT_HASH }}.zip
        wait_for_deployment: true
        wait_for_environment_recovery: 300
        
    - name: ðŸ§¹ Cleanup
      if: always()
      run: |
        rm -f deploy-*.zip
        rm -f Dockerrun.aws.json

  notification:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ðŸ“¢ Notify Deployment Result
      run: |
        if [ "${{ needs.build-and-deploy.result }}" == "success" ]; then
          echo "ðŸŽ‰ Deployment successful!"
          echo "âœ… Archive API has been successfully deployed to AWS Elastic Beanstalk"
          echo "ðŸŒ Environment: ${{ env.EB_ENVIRONMENT_NAME }}"
          echo "ðŸ“¦ Version: ${{ needs.build-and-deploy.outputs.IMAGE_TAG }}"
        else
          echo "âŒ Deployment failed!"
          echo "ðŸ” Please check the logs for details"
        fi
